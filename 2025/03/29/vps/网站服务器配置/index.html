<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon.ico">
  <link rel="mask-icon" href="/img/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zfonlyone.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="AI 生成 网站服务器配置完全指南本文详细介绍如何配置高性能、安全的Web服务器，包括Nginx和Apache的安装配置、SSL证书设置、PHP和缓存优化等内容。">
<meta property="og:type" content="article">
<meta property="og:title" content="网站服务器配置完全指南">
<meta property="og:url" content="https://zfonlyone.github.io/2025/03/29/vps/%E7%BD%91%E7%AB%99%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/index.html">
<meta property="og:site_name" content="代码诗集">
<meta property="og:description" content="AI 生成 网站服务器配置完全指南本文详细介绍如何配置高性能、安全的Web服务器，包括Nginx和Apache的安装配置、SSL证书设置、PHP和缓存优化等内容。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-28T18:00:01.000Z">
<meta property="article:modified_time" content="2025-03-28T18:00:01.000Z">
<meta property="article:author" content="zfonlyone">
<meta property="article:tag" content="AI生成">
<meta property="article:tag" content="nginx">
<meta property="article:tag" content="apache">
<meta property="article:tag" content="web">
<meta property="article:tag" content="ssl">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zfonlyone.github.io/2025/03/29/vps/%E7%BD%91%E7%AB%99%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zfonlyone.github.io/2025/03/29/vps/%E7%BD%91%E7%AB%99%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/","path":"2025/03/29/vps/网站服务器配置/","title":"网站服务器配置完全指南"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>网站服务器配置完全指南 | 代码诗集</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">代码诗集</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">技术与生活</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BD%91%E7%AB%99%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97"><span class="nav-number">1.</span> <span class="nav-text">网站服务器配置完全指南</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.</span> <span class="nav-text">1. Nginx服务器配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%AE%89%E8%A3%85Nginx"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 安装Nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 基本配置结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3 配置虚拟主机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E9%85%8D%E7%BD%AESSL-TLS"><span class="nav-number">1.1.4.</span> <span class="nav-text">1.4 配置SSL&#x2F;TLS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-%E4%BC%98%E5%8C%96Nginx%E6%80%A7%E8%83%BD"><span class="nav-number">1.1.5.</span> <span class="nav-text">1.5 优化Nginx性能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Apache%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.</span> <span class="nav-text">2. Apache服务器配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%AE%89%E8%A3%85Apache"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 安装Apache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 基本配置结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 配置虚拟主机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E9%85%8D%E7%BD%AESSL-TLS"><span class="nav-number">1.2.4.</span> <span class="nav-text">2.4 配置SSL&#x2F;TLS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-%E4%BC%98%E5%8C%96Apache%E6%80%A7%E8%83%BD"><span class="nav-number">1.2.5.</span> <span class="nav-text">2.5 优化Apache性能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-PHP%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96"><span class="nav-number">1.3.</span> <span class="nav-text">3. PHP配置优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E5%AE%89%E8%A3%85PHP-FPM"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 安装PHP-FPM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E9%85%8D%E7%BD%AEPHP-FPM"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2 配置PHP-FPM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E4%B8%8ENginx%E9%9B%86%E6%88%90"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.3 与Nginx集成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E4%B8%8EApache%E9%9B%86%E6%88%90"><span class="nav-number">1.3.4.</span> <span class="nav-text">3.4 与Apache集成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Web%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA"><span class="nav-number">1.4.</span> <span class="nav-text">4. Web服务器安全加固</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E9%9A%90%E8%97%8F%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BF%A1%E6%81%AF"><span class="nav-number">1.4.1.</span> <span class="nav-text">4.1 隐藏服务器信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E9%98%B2XSS%E5%92%8C%E7%82%B9%E5%87%BB%E5%8A%AB%E6%8C%81"><span class="nav-number">1.4.2.</span> <span class="nav-text">4.2 防XSS和点击劫持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E9%99%90%E5%88%B6%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84HTTP%E6%96%B9%E6%B3%95"><span class="nav-number">1.4.3.</span> <span class="nav-text">4.3 限制不必要的HTTP方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%E9%98%B2%E6%AD%A2%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86"><span class="nav-number">1.4.4.</span> <span class="nav-text">4.4 防止目录遍历</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-%E4%BD%BF%E7%94%A8ModSecurity-Web%E5%BA%94%E7%94%A8%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-number">1.4.5.</span> <span class="nav-text">4.5 使用ModSecurity Web应用防火墙</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E7%BD%91%E7%AB%99%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">1.5.</span> <span class="nav-text">5. 网站性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E9%85%8D%E7%BD%AE%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98"><span class="nav-number">1.5.1.</span> <span class="nav-text">5.1 配置浏览器缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%90%AF%E7%94%A8HTTP-2"><span class="nav-number">1.5.2.</span> <span class="nav-text">5.2 启用HTTP&#x2F;2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E4%BD%BF%E7%94%A8CDN%E5%8A%A0%E9%80%9F"><span class="nav-number">1.5.3.</span> <span class="nav-text">5.3 使用CDN加速</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-%E5%9B%BE%E7%89%87%E4%BC%98%E5%8C%96"><span class="nav-number">1.5.4.</span> <span class="nav-text">5.4 图片优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-%E4%BD%BF%E7%94%A8Redis%E7%BC%93%E5%AD%98"><span class="nav-number">1.5.5.</span> <span class="nav-text">5.5 使用Redis缓存</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E7%9B%91%E6%8E%A7%E4%B8%8E%E7%BB%B4%E6%8A%A4"><span class="nav-number">1.6.</span> <span class="nav-text">6. 监控与维护</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E8%AE%BE%E7%BD%AE%E6%97%A5%E5%BF%97%E8%BD%AE%E8%BD%AC"><span class="nav-number">1.6.1.</span> <span class="nav-text">6.1 设置日志轮转</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E8%87%AA%E5%8A%A8%E5%A4%87%E4%BB%BD%E9%85%8D%E7%BD%AE"><span class="nav-number">1.6.2.</span> <span class="nav-text">6.2 自动备份配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="nav-number">1.6.3.</span> <span class="nav-text">6.3 监控服务状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="nav-number">1.7.</span> <span class="nav-text">7. 常见问题排查</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-504-Gateway-Timeout"><span class="nav-number">1.7.1.</span> <span class="nav-text">7.1 504 Gateway Timeout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-403-Forbidden"><span class="nav-number">1.7.2.</span> <span class="nav-text">7.2 403 Forbidden</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-502-Bad-Gateway"><span class="nav-number">1.7.3.</span> <span class="nav-text">7.3 502 Bad Gateway</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="nav-number">1.7.4.</span> <span class="nav-text">7.4 性能问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.8.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zfonlyone</p>
  <div class="site-description" itemprop="description">记录技术学习与个人生活</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zfonlyone.github.io/2025/03/29/vps/%E7%BD%91%E7%AB%99%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zfonlyone">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="代码诗集">
      <meta itemprop="description" content="记录技术学习与个人生活">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="网站服务器配置完全指南 | 代码诗集">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          网站服务器配置完全指南
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-03-29 02:00:01" itemprop="dateCreated datePublished" datetime="2025-03-29T02:00:01+08:00">2025-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-03-29 02:00:01" itemprop="dateModified" datetime="2025-03-29T02:00:01+08:00">2025-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/vps/" itemprop="url" rel="index"><span itemprop="name">vps</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>AI 生成</p>
<h1 id="网站服务器配置完全指南"><a href="#网站服务器配置完全指南" class="headerlink" title="网站服务器配置完全指南"></a>网站服务器配置完全指南</h1><p>本文详细介绍如何配置高性能、安全的Web服务器，包括Nginx和Apache的安装配置、SSL证书设置、PHP和缓存优化等内容。</p>
<span id="more"></span>

<h2 id="1-Nginx服务器配置"><a href="#1-Nginx服务器配置" class="headerlink" title="1. Nginx服务器配置"></a>1. Nginx服务器配置</h2><p>Nginx因其高性能、低内存占用和出色的并发处理能力，成为当前最流行的Web服务器之一。</p>
<h3 id="1-1-安装Nginx"><a href="#1-1-安装Nginx" class="headerlink" title="1.1 安装Nginx"></a>1.1 安装Nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">apt update</span><br><span class="line">apt install nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line">yum install epel-release</span><br><span class="line">yum install nginx</span><br></pre></td></tr></table></figure>

<p>或使用官方源安装最新版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb http://nginx.org/packages/ubuntu/ <span class="subst">$(lsb_release -cs)</span> nginx&quot;</span> &gt; /etc/apt/sources.list.d/nginx.list</span><br><span class="line">curl -fsSL https://nginx.org/keys/nginx_signing.key | apt-key add -</span><br><span class="line">apt update</span><br><span class="line">apt install nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/yum.repos.d/nginx.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[nginx]</span></span><br><span class="line"><span class="string">name=nginx repo</span></span><br><span class="line"><span class="string">baseurl=https://nginx.org/packages/centos/\$releasever/\$basearch/</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">yum install nginx</span><br></pre></td></tr></table></figure>

<h3 id="1-2-基本配置结构"><a href="#1-2-基本配置结构" class="headerlink" title="1.2 基本配置结构"></a>1.2 基本配置结构</h3><p>Nginx的配置文件通常位于<code>/etc/nginx/nginx.conf</code>，主要包含以下部分：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"><span class="attribute">user</span> www-data;</span><br><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">pid</span> /run/nginx.pid;</span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/<span class="literal">error</span>.log;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 事件模块配置</span></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP配置</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># 基本设置</span></span><br><span class="line">    <span class="attribute">include</span> mime.types;</span><br><span class="line">    <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line">    <span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志配置</span></span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/access.log;</span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/<span class="literal">error</span>.log;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 性能优化</span></span><br><span class="line">    <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">65</span>;</span><br><span class="line">    <span class="attribute">types_hash_max_size</span> <span class="number">2048</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Gzip压缩</span></span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_proxied</span> any;</span><br><span class="line">    <span class="attribute">gzip_comp_level</span> <span class="number">6</span>;</span><br><span class="line">    <span class="attribute">gzip_types</span> text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 包含站点配置</span></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/sites-enabled/*;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-配置虚拟主机"><a href="#1-3-配置虚拟主机" class="headerlink" title="1.3 配置虚拟主机"></a>1.3 配置虚拟主机</h3><p>创建站点配置文件，例如<code>/etc/nginx/sites-available/example.com</code>：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> example.com www.example.com;</span><br><span class="line">    <span class="attribute">root</span> /var/www/example.com;</span><br><span class="line">    <span class="attribute">index</span> index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 错误页面</span></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 静态文件缓存</span></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~* \.(jpg|jpeg|png|gif|ico|css|js)$</span> &#123;</span><br><span class="line">        <span class="attribute">expires</span> <span class="number">30d</span>;</span><br><span class="line">        <span class="attribute">add_header</span> Cache-Control <span class="string">&quot;public, no-transform&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># PHP处理</span></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">        <span class="attribute">include</span> snippets/fastcgi-php.conf;</span><br><span class="line">        <span class="attribute">fastcgi_pass</span> unix:/var/run/php/php7.4-fpm.sock;</span><br><span class="line">        <span class="attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 拒绝访问隐藏文件</span></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ /\.</span> &#123;</span><br><span class="line">        <span class="attribute">deny</span> all;</span><br><span class="line">        <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">log_not_found</span> <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启用站点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/</span><br><span class="line">nginx -t  <span class="comment"># 检查配置</span></span><br><span class="line">systemctl reload nginx</span><br></pre></td></tr></table></figure>

<h3 id="1-4-配置SSL-TLS"><a href="#1-4-配置SSL-TLS" class="headerlink" title="1.4 配置SSL&#x2F;TLS"></a>1.4 配置SSL&#x2F;TLS</h3><p>安装Certbot获取免费SSL证书：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">apt install certbot python3-certbot-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line">yum install certbot python3-certbot-nginx</span><br></pre></td></tr></table></figure>

<p>获取并安装证书：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certbot --nginx -d example.com -d www.example.com</span><br></pre></td></tr></table></figure>

<p>或手动配置SSL：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span> example.com www.example.com;</span><br><span class="line">    <span class="attribute">root</span> /var/www/example.com;</span><br><span class="line">    <span class="attribute">index</span> index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/example.com/fullchain.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/example.com/privkey.pem;</span><br><span class="line">    <span class="attribute">ssl_trusted_certificate</span> /etc/letsencrypt/live/example.com/chain.pem;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SSL优化</span></span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">1d</span>;</span><br><span class="line">    <span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">ssl_stapling</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_stapling_verify</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">resolver</span> <span class="number">8.8.8.8</span> <span class="number">8.8.4.4</span> valid=<span class="number">300s</span>;</span><br><span class="line">    <span class="attribute">resolver_timeout</span> <span class="number">5s</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=63072000&quot;</span> always;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ... 其余配置与HTTP相同</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP重定向到HTTPS</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> example.com www.example.com;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-5-优化Nginx性能"><a href="#1-5-优化Nginx性能" class="headerlink" title="1.5 优化Nginx性能"></a>1.5 优化Nginx性能</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局优化</span></span><br><span class="line"><span class="attribute">worker_processes</span> auto;  <span class="comment"># 自动设为CPU核心数</span></span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">65535</span>;  <span class="comment"># 提高打开文件数限制</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">10240</span>;  <span class="comment"># 提高连接数</span></span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># 启用缓存</span></span><br><span class="line">    <span class="attribute">open_file_cache</span> max=<span class="number">200000</span> inactive=<span class="number">20s</span>;</span><br><span class="line">    <span class="attribute">open_file_cache_valid</span> <span class="number">30s</span>;</span><br><span class="line">    <span class="attribute">open_file_cache_min_uses</span> <span class="number">2</span>;</span><br><span class="line">    <span class="attribute">open_file_cache_errors</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 优化缓冲区</span></span><br><span class="line">    <span class="attribute">client_body_buffer_size</span> <span class="number">10K</span>;</span><br><span class="line">    <span class="attribute">client_header_buffer_size</span> <span class="number">1k</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">8m</span>;</span><br><span class="line">    <span class="attribute">large_client_header_buffers</span> <span class="number">2</span> <span class="number">1k</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 超时设置</span></span><br><span class="line">    <span class="attribute">client_body_timeout</span> <span class="number">12</span>;</span><br><span class="line">    <span class="attribute">client_header_timeout</span> <span class="number">12</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">15</span>;</span><br><span class="line">    <span class="attribute">send_timeout</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Gzip压缩优化</span></span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_comp_level</span> <span class="number">5</span>;</span><br><span class="line">    <span class="attribute">gzip_min_length</span> <span class="number">256</span>;</span><br><span class="line">    <span class="attribute">gzip_proxied</span> any;</span><br><span class="line">    <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_types</span></span><br><span class="line">        application/atom+xml</span><br><span class="line">        application/javascript</span><br><span class="line">        application/json</span><br><span class="line">        application/ld+json</span><br><span class="line">        application/manifest+json</span><br><span class="line">        application/rss+xml</span><br><span class="line">        application/vnd.geo+json</span><br><span class="line">        application/vnd.ms-fontobject</span><br><span class="line">        application/x-font-ttf</span><br><span class="line">        application/x-web-app-manifest+json</span><br><span class="line">        application/xhtml+xml</span><br><span class="line">        application/xml</span><br><span class="line">        font/opentype</span><br><span class="line">        image/bmp</span><br><span class="line">        image/svg+xml</span><br><span class="line">        image/x-icon</span><br><span class="line">        text/cache-manifest</span><br><span class="line">        text/css</span><br><span class="line">        text/plain</span><br><span class="line">        text/vcard</span><br><span class="line">        text/vnd.rim.location.xloc</span><br><span class="line">        text/vtt</span><br><span class="line">        text/x-component</span><br><span class="line">        text/x-cross-domain-policy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Apache服务器配置"><a href="#2-Apache服务器配置" class="headerlink" title="2. Apache服务器配置"></a>2. Apache服务器配置</h2><p>Apache HTTP Server是历史最悠久的Web服务器之一，具有强大的功能和模块化设计。</p>
<h3 id="2-1-安装Apache"><a href="#2-1-安装Apache" class="headerlink" title="2.1 安装Apache"></a>2.1 安装Apache</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">apt update</span><br><span class="line">apt install apache2</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line">yum install httpd</span><br></pre></td></tr></table></figure>

<h3 id="2-2-基本配置结构"><a href="#2-2-基本配置结构" class="headerlink" title="2.2 基本配置结构"></a>2.2 基本配置结构</h3><p>Apache的主配置文件通常位于：</p>
<ul>
<li>Ubuntu&#x2F;Debian: <code>/etc/apache2/apache2.conf</code></li>
<li>CentOS&#x2F;RHEL: <code>/etc/httpd/conf/httpd.conf</code></li>
</ul>
<p>基本配置结构：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"><span class="attribute">ServerRoot</span> <span class="string">&quot;/etc/apache2&quot;</span></span><br><span class="line"><span class="attribute">Listen</span> <span class="number">80</span></span><br><span class="line"><span class="attribute">ServerAdmin</span> webmaster@localhost</span><br><span class="line"><span class="attribute">ServerName</span> server.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块加载</span></span><br><span class="line"><span class="attribute">LoadModule</span> rewrite_module modules/mod_rewrite.so</span><br><span class="line"><span class="attribute">LoadModule</span> ssl_module modules/mod_ssl.so</span><br><span class="line"><span class="comment"># ... 其他模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主要配置</span></span><br><span class="line"><span class="attribute">DocumentRoot</span> <span class="string">&quot;/var/www/html&quot;</span></span><br><span class="line"><span class="section">&lt;Directory <span class="string">&quot;/var/www/html&quot;</span>&gt;</span></span><br><span class="line">    <span class="attribute">Options</span> Indexes FollowSymLinks</span><br><span class="line">    <span class="attribute">AllowOverride</span> <span class="literal">All</span></span><br><span class="line">    <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line"><span class="section">&lt;/Directory&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认网站设置</span></span><br><span class="line"><span class="section">&lt;VirtualHost *<span class="number">:80</span>&gt;</span></span><br><span class="line">    <span class="attribute">ServerAdmin</span> webmaster@localhost</span><br><span class="line">    <span class="attribute">DocumentRoot</span> /var/www/html</span><br><span class="line">    <span class="attribute">ErrorLog</span> <span class="variable">$&#123;APACHE_LOG_DIR&#125;</span>/error.log</span><br><span class="line">    <span class="attribute">CustomLog</span> <span class="variable">$&#123;APACHE_LOG_DIR&#125;</span>/access.log combined</span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含其他配置文件</span></span><br><span class="line"><span class="attribute">Include</span> conf.d/*.conf</span><br><span class="line"><span class="attribute">Include</span> sites-enabled/*.conf</span><br></pre></td></tr></table></figure>

<h3 id="2-3-配置虚拟主机"><a href="#2-3-配置虚拟主机" class="headerlink" title="2.3 配置虚拟主机"></a>2.3 配置虚拟主机</h3><p>创建虚拟主机配置：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian: /etc/apache2/sites-available/example.com.conf</span></span><br><span class="line"><span class="comment"># CentOS/RHEL: /etc/httpd/conf.d/example.com.conf</span></span><br><span class="line"></span><br><span class="line"><span class="section">&lt;VirtualHost *<span class="number">:80</span>&gt;</span></span><br><span class="line">    <span class="attribute">ServerName</span> example.com</span><br><span class="line">    <span class="attribute">ServerAlias</span> www.example.com</span><br><span class="line">    <span class="attribute">DocumentRoot</span> /var/www/example.com</span><br><span class="line">    <span class="attribute">ErrorLog</span> <span class="variable">$&#123;APACHE_LOG_DIR&#125;</span>/example.com_error.log</span><br><span class="line">    <span class="attribute">CustomLog</span> <span class="variable">$&#123;APACHE_LOG_DIR&#125;</span>/example.com_access.log combined</span><br><span class="line"></span><br><span class="line">    <span class="section">&lt;Directory /var/www/example.com&gt;</span></span><br><span class="line">        <span class="attribute">Options</span> Indexes FollowSymLinks</span><br><span class="line">        <span class="attribute">AllowOverride</span> <span class="literal">All</span></span><br><span class="line">        <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">    <span class="section">&lt;/Directory&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># PHP配置 (如果使用mod_php)</span></span><br><span class="line">    <span class="section">&lt;FilesMatch \.php$&gt;</span></span><br><span class="line">        <span class="attribute">SetHandler</span> application/x-httpd-php</span><br><span class="line">    <span class="section">&lt;/FilesMatch&gt;</span></span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure>

<p>在Ubuntu&#x2F;Debian上启用站点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a2ensite example.com.conf</span><br><span class="line">systemctl reload apache2</span><br></pre></td></tr></table></figure>

<h3 id="2-4-配置SSL-TLS"><a href="#2-4-配置SSL-TLS" class="headerlink" title="2.4 配置SSL&#x2F;TLS"></a>2.4 配置SSL&#x2F;TLS</h3><p>安装SSL模块：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">apt install ssl-cert</span><br><span class="line">a2enmod ssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line">yum install mod_ssl</span><br></pre></td></tr></table></figure>

<p>使用Certbot获取证书：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">apt install certbot python3-certbot-apache</span><br><span class="line">certbot --apache -d example.com -d www.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line">yum install certbot python3-certbot-apache</span><br><span class="line">certbot --apache -d example.com -d www.example.com</span><br></pre></td></tr></table></figure>

<p>或手动配置SSL：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;VirtualHost *<span class="number">:443</span>&gt;</span></span><br><span class="line">    <span class="attribute">ServerName</span> example.com</span><br><span class="line">    <span class="attribute">ServerAlias</span> www.example.com</span><br><span class="line">    <span class="attribute">DocumentRoot</span> /var/www/example.com</span><br><span class="line"></span><br><span class="line">    <span class="attribute">SSLEngine</span> <span class="literal">on</span></span><br><span class="line">    <span class="attribute">SSLCertificateFile</span> /etc/letsencrypt/live/example.com/fullchain.pem</span><br><span class="line">    <span class="attribute">SSLCertificateKeyFile</span> /etc/letsencrypt/live/example.com/privkey.pem</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SSL优化</span></span><br><span class="line">    <span class="attribute">SSLProtocol</span> <span class="literal">all</span> -SSLv3 -TLSv1 -TLSv1.<span class="number">1</span></span><br><span class="line">    <span class="attribute">SSLCipherSuite</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384</span><br><span class="line">    <span class="attribute">SSLHonorCipherOrder</span> <span class="literal">off</span></span><br><span class="line">    <span class="attribute">SSLSessionTickets</span> <span class="literal">off</span></span><br><span class="line">    <span class="attribute">SSLSessionCache</span> shmcb:/var/lib/apache2/ssl_scache(<span class="number">512000</span>)</span><br><span class="line">    <span class="attribute">SSLSessionTimeout</span> <span class="number">300</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># HSTS (HTTP Strict Transport Security)</span></span><br><span class="line">    <span class="attribute">Header</span> always set Strict-Transport-Security <span class="string">&quot;max-age=63072000&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ... 其余配置与HTTP相同</span></span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP重定向到HTTPS</span></span><br><span class="line"><span class="section">&lt;VirtualHost *<span class="number">:80</span>&gt;</span></span><br><span class="line">    <span class="attribute">ServerName</span> example.com</span><br><span class="line">    <span class="attribute">ServerAlias</span> www.example.com</span><br><span class="line">    <span class="attribute">Redirect</span> permanent / https://example.com/</span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5-优化Apache性能"><a href="#2-5-优化Apache性能" class="headerlink" title="2.5 优化Apache性能"></a>2.5 优化Apache性能</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MPM Worker 配置 (在/etc/apache2/mods-available/mpm_worker.conf)</span></span><br><span class="line"><span class="section">&lt;IfModule mpm_worker_module&gt;</span></span><br><span class="line">    <span class="attribute">StartServers</span>             <span class="number">2</span></span><br><span class="line">    <span class="attribute">MinSpareThreads</span>         <span class="number">25</span></span><br><span class="line">    <span class="attribute">MaxSpareThreads</span>         <span class="number">75</span></span><br><span class="line">    <span class="attribute">ThreadLimit</span>             <span class="number">64</span></span><br><span class="line">    <span class="attribute">ThreadsPerChild</span>         <span class="number">25</span></span><br><span class="line">    <span class="attribute">MaxRequestWorkers</span>      <span class="number">150</span></span><br><span class="line">    <span class="attribute">MaxConnectionsPerChild</span>   <span class="number">0</span></span><br><span class="line"><span class="section">&lt;/IfModule&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 MPM Event (更高性能)</span></span><br><span class="line"><span class="section">&lt;IfModule mpm_event_module&gt;</span></span><br><span class="line">    <span class="attribute">StartServers</span>             <span class="number">2</span></span><br><span class="line">    <span class="attribute">MinSpareThreads</span>         <span class="number">25</span></span><br><span class="line">    <span class="attribute">MaxSpareThreads</span>         <span class="number">75</span></span><br><span class="line">    <span class="attribute">ThreadLimit</span>             <span class="number">64</span></span><br><span class="line">    <span class="attribute">ThreadsPerChild</span>         <span class="number">25</span></span><br><span class="line">    <span class="attribute">MaxRequestWorkers</span>      <span class="number">150</span></span><br><span class="line">    <span class="attribute">MaxConnectionsPerChild</span>   <span class="number">0</span></span><br><span class="line"><span class="section">&lt;/IfModule&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用缓存模块</span></span><br><span class="line"><span class="section">&lt;IfModule mod_expires.c&gt;</span></span><br><span class="line">    <span class="attribute">ExpiresActive</span> <span class="literal">On</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> image/jpg <span class="string">&quot;access plus 1 year&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> image/jpeg <span class="string">&quot;access plus 1 year&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> image/gif <span class="string">&quot;access plus 1 year&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> image/png <span class="string">&quot;access plus 1 year&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> text/css <span class="string">&quot;access plus 1 month&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> application/javascript <span class="string">&quot;access plus 1 month&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> text/javascript <span class="string">&quot;access plus 1 month&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> application/x-javascript <span class="string">&quot;access plus 1 month&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> text/html <span class="string">&quot;access plus 1 month&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> application/xhtml+xml <span class="string">&quot;access plus 1 month&quot;</span></span><br><span class="line"><span class="section">&lt;/IfModule&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用压缩</span></span><br><span class="line"><span class="section">&lt;IfModule mod_deflate.c&gt;</span></span><br><span class="line">    <span class="attribute">AddOutputFilterByType</span> DEFLATE text/html text/plain text/xml text/css</span><br><span class="line">    <span class="attribute">AddOutputFilterByType</span> DEFLATE application/x-javascript application/javascript application/ecmascript</span><br><span class="line">    <span class="attribute">AddOutputFilterByType</span> DEFLATE application/rss+xml</span><br><span class="line">    <span class="attribute">AddOutputFilterByType</span> DEFLATE application/xml</span><br><span class="line"><span class="section">&lt;/IfModule&gt;</span></span><br></pre></td></tr></table></figure>

<p>在Ubuntu&#x2F;Debian上，切换MPM模块：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a2dismod mpm_prefork</span><br><span class="line">a2enmod mpm_event</span><br><span class="line">systemctl restart apache2</span><br></pre></td></tr></table></figure>

<h2 id="3-PHP配置优化"><a href="#3-PHP配置优化" class="headerlink" title="3. PHP配置优化"></a>3. PHP配置优化</h2><p>无论使用Nginx还是Apache，正确配置PHP对网站性能都至关重要。</p>
<h3 id="3-1-安装PHP-FPM"><a href="#3-1-安装PHP-FPM" class="headerlink" title="3.1 安装PHP-FPM"></a>3.1 安装PHP-FPM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">apt install php-fpm php-mysql php-common php-gd php-xml php-mbstring php-zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line">yum install php-fpm php-mysqlnd php-common php-gd php-xml php-mbstring php-zip</span><br></pre></td></tr></table></figure>

<h3 id="3-2-配置PHP-FPM"><a href="#3-2-配置PHP-FPM" class="headerlink" title="3.2 配置PHP-FPM"></a>3.2 配置PHP-FPM</h3><p>主配置文件位于：</p>
<ul>
<li>Ubuntu&#x2F;Debian: <code>/etc/php/7.4/fpm/php.ini</code> (版本号可能不同)</li>
<li>CentOS&#x2F;RHEL: <code>/etc/php.ini</code> 和 <code>/etc/php-fpm.d/www.conf</code></li>
</ul>
<p>性能优化:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; php.ini 配置优化</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; 内存限制</span></span><br><span class="line"><span class="attr">memory_limit</span> = <span class="number">256</span>M</span><br><span class="line"></span><br><span class="line"><span class="comment">; 最大执行时间</span></span><br><span class="line"><span class="attr">max_execution_time</span> = <span class="number">60</span></span><br><span class="line"><span class="attr">max_input_time</span> = <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; 文件上传</span></span><br><span class="line"><span class="attr">upload_max_filesize</span> = <span class="number">20</span>M</span><br><span class="line"><span class="attr">post_max_size</span> = <span class="number">21</span>M</span><br><span class="line"></span><br><span class="line"><span class="comment">; 错误处理 (生产环境)</span></span><br><span class="line"><span class="attr">error_reporting</span> = E_ALL &amp; ~E_DEPRECATED &amp; ~E_STRICT</span><br><span class="line"><span class="attr">display_errors</span> = <span class="literal">Off</span></span><br><span class="line"><span class="attr">display_startup_errors</span> = <span class="literal">Off</span></span><br><span class="line"><span class="attr">log_errors</span> = <span class="literal">On</span></span><br><span class="line"><span class="attr">error_log</span> = /var/log/php/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment">; OPcache设置</span></span><br><span class="line"><span class="attr">opcache.enable</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">opcache.memory_consumption</span>=<span class="number">128</span></span><br><span class="line"><span class="attr">opcache.interned_strings_buffer</span>=<span class="number">8</span></span><br><span class="line"><span class="attr">opcache.max_accelerated_files</span>=<span class="number">4000</span></span><br><span class="line"><span class="attr">opcache.revalidate_freq</span>=<span class="number">60</span></span><br><span class="line"><span class="attr">opcache.fast_shutdown</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">opcache.enable_cli</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>PHP-FPM池配置 (<code>www.conf</code>):</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; PHP-FPM进程管理</span></span><br><span class="line"><span class="attr">pm</span> = dynamic</span><br><span class="line"><span class="attr">pm.max_children</span> = <span class="number">50</span></span><br><span class="line"><span class="attr">pm.start_servers</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">pm.min_spare_servers</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">pm.max_spare_servers</span> = <span class="number">35</span></span><br><span class="line"><span class="attr">pm.max_requests</span> = <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; 超时设置</span></span><br><span class="line"><span class="attr">request_terminate_timeout</span> = <span class="number">300</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-与Nginx集成"><a href="#3-3-与Nginx集成" class="headerlink" title="3.3 与Nginx集成"></a>3.3 与Nginx集成</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">    <span class="attribute">fastcgi_pass</span> unix:/var/run/php/php7.4-fpm.sock;</span><br><span class="line">    <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">    <span class="attribute">fastcgi_param</span> SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">    <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">    <span class="attribute">fastcgi_buffer_size</span> <span class="number">128k</span>;</span><br><span class="line">    <span class="attribute">fastcgi_buffers</span> <span class="number">256</span> <span class="number">16k</span>;</span><br><span class="line">    <span class="attribute">fastcgi_busy_buffers_size</span> <span class="number">256k</span>;</span><br><span class="line">    <span class="attribute">fastcgi_temp_file_write_size</span> <span class="number">256k</span>;</span><br><span class="line">    <span class="attribute">fastcgi_read_timeout</span> <span class="number">300</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-与Apache集成"><a href="#3-4-与Apache集成" class="headerlink" title="3.4 与Apache集成"></a>3.4 与Apache集成</h3><p>首先启用必要的模块：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">a2enmod proxy_fcgi setenvif</span><br><span class="line">a2enconf php7.4-fpm  <span class="comment"># 版本可能不同</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line"><span class="comment"># 模块通常自动加载</span></span><br></pre></td></tr></table></figure>

<p>配置虚拟主机：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;VirtualHost *<span class="number">:80</span>&gt;</span></span><br><span class="line">    <span class="comment"># ... 其他配置</span></span><br><span class="line"></span><br><span class="line">    <span class="section">&lt;FilesMatch \.php$&gt;</span></span><br><span class="line">        <span class="attribute">SetHandler</span> <span class="string">&quot;proxy:unix:/var/run/php/php7.4-fpm.sock|fcgi://localhost&quot;</span></span><br><span class="line">    <span class="section">&lt;/FilesMatch&gt;</span></span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="4-Web服务器安全加固"><a href="#4-Web服务器安全加固" class="headerlink" title="4. Web服务器安全加固"></a>4. Web服务器安全加固</h2><h3 id="4-1-隐藏服务器信息"><a href="#4-1-隐藏服务器信息" class="headerlink" title="4.1 隐藏服务器信息"></a>4.1 隐藏服务器信息</h3><p>Nginx:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br></pre></td></tr></table></figure>

<p>Apache:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ServerTokens</span> Prod</span><br><span class="line"><span class="attribute">ServerSignature</span> <span class="literal">Off</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-防XSS和点击劫持"><a href="#4-2-防XSS和点击劫持" class="headerlink" title="4.2 防XSS和点击劫持"></a>4.2 防XSS和点击劫持</h3><p>添加安全响应头：</p>
<p>Nginx:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">add_header</span> X-XSS-Protection <span class="string">&quot;1; mode=block&quot;</span> always;</span><br><span class="line"><span class="attribute">add_header</span> X-Content-Type-Options <span class="string">&quot;nosniff&quot;</span> always;</span><br><span class="line"><span class="attribute">add_header</span> X-Frame-Options <span class="string">&quot;SAMEORIGIN&quot;</span> always;</span><br><span class="line"><span class="attribute">add_header</span> Content-Security-Policy <span class="string">&quot;default-src &#x27;self&#x27; https: data: &#x27;unsafe-inline&#x27; &#x27;unsafe-eval&#x27;;&quot;</span> always;</span><br><span class="line"><span class="attribute">add_header</span> Referrer-Policy <span class="string">&quot;no-referrer-when-downgrade&quot;</span> always;</span><br></pre></td></tr></table></figure>

<p>Apache:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;IfModule mod_headers.c&gt;</span></span><br><span class="line">    <span class="attribute">Header</span> set X-XSS-Protection <span class="string">&quot;1; mode=block&quot;</span></span><br><span class="line">    <span class="attribute">Header</span> set X-Content-Type-Options <span class="string">&quot;nosniff&quot;</span></span><br><span class="line">    <span class="attribute">Header</span> set X-Frame-Options <span class="string">&quot;SAMEORIGIN&quot;</span></span><br><span class="line">    <span class="attribute">Header</span> set Content-Security-Policy <span class="string">&quot;default-src &#x27;self&#x27; https: data: &#x27;unsafe-inline&#x27; &#x27;unsafe-eval&#x27;;&quot;</span></span><br><span class="line">    <span class="attribute">Header</span> set Referrer-Policy <span class="string">&quot;no-referrer-when-downgrade&quot;</span></span><br><span class="line"><span class="section">&lt;/IfModule&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-限制不必要的HTTP方法"><a href="#4-3-限制不必要的HTTP方法" class="headerlink" title="4.3 限制不必要的HTTP方法"></a>4.3 限制不必要的HTTP方法</h3><p>Nginx:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~ ^(GET|HEAD|POST)$)</span> &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">405</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Apache:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;LimitExcept GET POST HEAD&gt;</span></span><br><span class="line">    <span class="attribute">deny</span> from <span class="literal">all</span></span><br><span class="line"><span class="section">&lt;/LimitExcept&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-防止目录遍历"><a href="#4-4-防止目录遍历" class="headerlink" title="4.4 防止目录遍历"></a>4.4 防止目录遍历</h3><p>Nginx:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> <span class="regexp">~ /\.(?!well-known)</span> &#123;</span><br><span class="line">    <span class="attribute">deny</span> all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Apache:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;Directory /var/www/html&gt;</span></span><br><span class="line">    <span class="attribute">Options</span> -Indexes</span><br><span class="line">    <span class="attribute">AllowOverride</span> None</span><br><span class="line"><span class="section">&lt;/Directory&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-5-使用ModSecurity-Web应用防火墙"><a href="#4-5-使用ModSecurity-Web应用防火墙" class="headerlink" title="4.5 使用ModSecurity Web应用防火墙"></a>4.5 使用ModSecurity Web应用防火墙</h3><p>Apache:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装ModSecurity</span></span><br><span class="line">apt install libapache2-mod-security2  <span class="comment"># Ubuntu/Debian</span></span><br><span class="line">yum install mod_security              <span class="comment"># CentOS/RHEL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置基本规则</span></span><br><span class="line"><span class="built_in">cp</span> /etc/modsecurity/modsecurity.conf-recommended /etc/modsecurity/modsecurity.conf</span><br></pre></td></tr></table></figure>

<p>修改<code>/etc/modsecurity/modsecurity.conf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SecRuleEngine On</span><br></pre></td></tr></table></figure>

<p>Nginx:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译安装ModSecurity-nginx</span></span><br><span class="line">apt install libmodsecurity-dev  <span class="comment"># Ubuntu/Debian</span></span><br><span class="line">yum install modsecurity        <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure>

<p>Nginx配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">load_module</span> modules/ngx_http_modsecurity_module.so;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">modsecurity</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">modsecurity_rules_file</span> /etc/nginx/modsec/main.conf;</span><br><span class="line">    <span class="comment"># ... 其他配置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-网站性能优化"><a href="#5-网站性能优化" class="headerlink" title="5. 网站性能优化"></a>5. 网站性能优化</h2><h3 id="5-1-配置浏览器缓存"><a href="#5-1-配置浏览器缓存" class="headerlink" title="5.1 配置浏览器缓存"></a>5.1 配置浏览器缓存</h3><p>Nginx:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> <span class="regexp">~* \.(jpg|jpeg|png|gif|ico|css|js)$</span> &#123;</span><br><span class="line">    <span class="attribute">expires</span> <span class="number">30d</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Cache-Control <span class="string">&quot;public, no-transform&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Apache:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;IfModule mod_expires.c&gt;</span></span><br><span class="line">    <span class="attribute">ExpiresActive</span> <span class="literal">On</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> image/jpg <span class="string">&quot;access plus 1 year&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> image/jpeg <span class="string">&quot;access plus 1 year&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> image/gif <span class="string">&quot;access plus 1 year&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> image/png <span class="string">&quot;access plus 1 year&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> text/css <span class="string">&quot;access plus 1 month&quot;</span></span><br><span class="line">    <span class="attribute">ExpiresByType</span> application/javascript <span class="string">&quot;access plus 1 month&quot;</span></span><br><span class="line"><span class="section">&lt;/IfModule&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-启用HTTP-2"><a href="#5-2-启用HTTP-2" class="headerlink" title="5.2 启用HTTP&#x2F;2"></a>5.2 启用HTTP&#x2F;2</h3><p>Nginx:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="comment"># ... 其他配置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Apache:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用http2模块</span></span><br><span class="line">a2enmod http2  <span class="comment"># Ubuntu/Debian</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">&lt;VirtualHost *:443&gt;</span><br><span class="line">    Protocols h2 http/1.1</span><br><span class="line">    <span class="comment"># ... 其他配置</span></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-使用CDN加速"><a href="#5-3-使用CDN加速" class="headerlink" title="5.3 使用CDN加速"></a>5.3 使用CDN加速</h3><p>以Cloudflare为例，配置DNS指向Cloudflare，然后：</p>
<ol>
<li>在Cloudflare中启用”Proxied”模式</li>
<li>启用SSL (推荐”Full”或”Full (Strict)”)</li>
<li>启用缓存和优化功能</li>
</ol>
<h3 id="5-4-图片优化"><a href="#5-4-图片优化" class="headerlink" title="5.4 图片优化"></a>5.4 图片优化</h3><p>安装和使用图片优化工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装优化工具</span></span><br><span class="line">apt install jpegoptim optipng  <span class="comment"># Ubuntu/Debian</span></span><br><span class="line">yum install jpegoptim optipng  <span class="comment"># CentOS/RHEL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量优化图片</span></span><br><span class="line">find /var/www/html -name <span class="string">&quot;*.jpg&quot;</span> -<span class="built_in">exec</span> jpegoptim --strip-all &#123;&#125; \;</span><br><span class="line">find /var/www/html -name <span class="string">&quot;*.png&quot;</span> -<span class="built_in">exec</span> optipng -o5 &#123;&#125; \;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-使用Redis缓存"><a href="#5-5-使用Redis缓存" class="headerlink" title="5.5 使用Redis缓存"></a>5.5 使用Redis缓存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装Redis</span></span><br><span class="line">apt install redis-server  <span class="comment"># Ubuntu/Debian</span></span><br><span class="line">yum install redis         <span class="comment"># CentOS/RHEL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装PHP Redis扩展</span></span><br><span class="line">apt install php-redis     <span class="comment"># Ubuntu/Debian</span></span><br><span class="line">yum install php-redis     <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure>

<p>对于WordPress等CMS，可以安装Redis缓存插件。</p>
<h2 id="6-监控与维护"><a href="#6-监控与维护" class="headerlink" title="6. 监控与维护"></a>6. 监控与维护</h2><h3 id="6-1-设置日志轮转"><a href="#6-1-设置日志轮转" class="headerlink" title="6.1 设置日志轮转"></a>6.1 设置日志轮转</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置logrotate</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/logrotate.d/nginx &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">/var/log/nginx/*.log &#123;</span></span><br><span class="line"><span class="string">    daily</span></span><br><span class="line"><span class="string">    missingok</span></span><br><span class="line"><span class="string">    rotate 14</span></span><br><span class="line"><span class="string">    compress</span></span><br><span class="line"><span class="string">    delaycompress</span></span><br><span class="line"><span class="string">    notifempty</span></span><br><span class="line"><span class="string">    create 0640 www-data adm</span></span><br><span class="line"><span class="string">    sharedscripts</span></span><br><span class="line"><span class="string">    postrotate</span></span><br><span class="line"><span class="string">        if [ -f /var/run/nginx.pid ]; then</span></span><br><span class="line"><span class="string">            kill -USR1 \`cat /var/run/nginx.pid\`</span></span><br><span class="line"><span class="string">        fi</span></span><br><span class="line"><span class="string">    endscript</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-自动备份配置"><a href="#6-2-自动备份配置" class="headerlink" title="6.2 自动备份配置"></a>6.2 自动备份配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建备份脚本 /usr/local/bin/backup-web-config.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/var/backups/web-config&quot;</span></span><br><span class="line">DATE=$(<span class="built_in">date</span> +%Y-%m-%d)</span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$BACKUP_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份Nginx配置</span></span><br><span class="line"><span class="keyword">if</span> [ -d /etc/nginx ]; <span class="keyword">then</span></span><br><span class="line">    tar -czf <span class="variable">$BACKUP_DIR</span>/nginx-<span class="variable">$DATE</span>.tar.gz /etc/nginx</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份Apache配置</span></span><br><span class="line"><span class="keyword">if</span> [ -d /etc/apache2 ] || [ -d /etc/httpd ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ -d /etc/apache2 ]; <span class="keyword">then</span></span><br><span class="line">        tar -czf <span class="variable">$BACKUP_DIR</span>/apache-<span class="variable">$DATE</span>.tar.gz /etc/apache2</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        tar -czf <span class="variable">$BACKUP_DIR</span>/apache-<span class="variable">$DATE</span>.tar.gz /etc/httpd</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份PHP配置</span></span><br><span class="line"><span class="keyword">if</span> [ -d /etc/php ]; <span class="keyword">then</span></span><br><span class="line">    tar -czf <span class="variable">$BACKUP_DIR</span>/php-<span class="variable">$DATE</span>.tar.gz /etc/php</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除超过30天的备份</span></span><br><span class="line">find <span class="variable">$BACKUP_DIR</span> -name <span class="string">&quot;*.tar.gz&quot;</span> -<span class="built_in">type</span> f -mtime +30 -delete</span><br></pre></td></tr></table></figure>

<p>执行权限与定时任务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/backup-web-config.sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;0 2 * * * root /usr/local/bin/backup-web-config.sh&quot;</span> &gt; /etc/cron.d/backup-web-config</span><br></pre></td></tr></table></figure>

<h3 id="6-3-监控服务状态"><a href="#6-3-监控服务状态" class="headerlink" title="6.3 监控服务状态"></a>6.3 监控服务状态</h3><p>使用简单监控脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># /usr/local/bin/check-web-services.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查服务状态</span></span><br><span class="line"><span class="function"><span class="title">check_service</span></span>() &#123;</span><br><span class="line">    systemctl is-active --quiet <span class="variable">$1</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> is running&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> is DOWN!&quot;</span></span><br><span class="line">        <span class="comment"># 尝试重启服务</span></span><br><span class="line">        systemctl restart <span class="variable">$1</span></span><br><span class="line">        <span class="comment"># 发送告警</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> was down on <span class="subst">$(hostname)</span> and has been restarted&quot;</span> | mail -s <span class="string">&quot;Service Alert: <span class="variable">$1</span>&quot;</span> admin@example.com</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查网站可访问性</span></span><br><span class="line"><span class="function"><span class="title">check_website</span></span>() &#123;</span><br><span class="line">    HTTP_CODE=$(curl -s -o /dev/null -w <span class="string">&quot;%&#123;http_code&#125;&quot;</span> <span class="variable">$1</span>)</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$HTTP_CODE</span>&quot;</span> = <span class="string">&quot;200&quot;</span> ] || [ <span class="string">&quot;<span class="variable">$HTTP_CODE</span>&quot;</span> = <span class="string">&quot;301&quot;</span> ] || [ <span class="string">&quot;<span class="variable">$HTTP_CODE</span>&quot;</span> = <span class="string">&quot;302&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> is accessible (HTTP <span class="variable">$HTTP_CODE</span>)&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> is DOWN! (HTTP <span class="variable">$HTTP_CODE</span>)&quot;</span></span><br><span class="line">        <span class="comment"># 发送告警</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> is returning HTTP <span class="variable">$HTTP_CODE</span> on <span class="subst">$(hostname)</span>&quot;</span> | mail -s <span class="string">&quot;Website Alert: <span class="variable">$1</span>&quot;</span> admin@example.com</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查服务</span></span><br><span class="line">check_service nginx  <span class="comment"># 或 apache2/httpd</span></span><br><span class="line">check_service php7.4-fpm  <span class="comment"># 版本可能不同</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查网站</span></span><br><span class="line">check_website https://example.com</span><br></pre></td></tr></table></figure>

<p>设置定时任务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/check-web-services.sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;*/5 * * * * root /usr/local/bin/check-web-services.sh&quot;</span> &gt; /etc/cron.d/check-web-services</span><br></pre></td></tr></table></figure>

<h2 id="7-常见问题排查"><a href="#7-常见问题排查" class="headerlink" title="7. 常见问题排查"></a>7. 常见问题排查</h2><h3 id="7-1-504-Gateway-Timeout"><a href="#7-1-504-Gateway-Timeout" class="headerlink" title="7.1 504 Gateway Timeout"></a>7.1 504 Gateway Timeout</h3><p>常见原因：PHP处理超时</p>
<p>解决方案：</p>
<ol>
<li><p>增加Nginx超时设置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fastcgi_read_timeout</span> <span class="number">300</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>增加PHP-FPM超时设置</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">request_terminate_timeout</span> = <span class="number">300</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>检查PHP脚本性能问题</p>
</li>
</ol>
<h3 id="7-2-403-Forbidden"><a href="#7-2-403-Forbidden" class="headerlink" title="7.2 403 Forbidden"></a>7.2 403 Forbidden</h3><p>常见原因：权限问题</p>
<p>解决方案：</p>
<ol>
<li><p>检查文件权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> -R 755 /var/www/html</span><br><span class="line"><span class="built_in">chown</span> -R www-data:www-data /var/www/html  <span class="comment"># Ubuntu/Debian</span></span><br><span class="line"><span class="built_in">chown</span> -R apache:apache /var/www/html       <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>检查SELinux (CentOS&#x2F;RHEL)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">restorecon -R /var/www/html</span><br><span class="line"><span class="comment"># 或永久更改上下文</span></span><br><span class="line">semanage fcontext -a -t httpd_sys_content_t <span class="string">&quot;/var/www/html(/.*)?&quot;</span></span><br><span class="line">restorecon -R /var/www/html</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="7-3-502-Bad-Gateway"><a href="#7-3-502-Bad-Gateway" class="headerlink" title="7.3 502 Bad Gateway"></a>7.3 502 Bad Gateway</h3><p>常见原因：PHP-FPM未运行或配置错误</p>
<p>解决方案：</p>
<ol>
<li><p>检查PHP-FPM状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status php7.4-fpm  <span class="comment"># 版本可能不同</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>检查socket路径是否匹配</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看实际socket路径</span></span><br><span class="line">grep <span class="string">&quot;listen =&quot;</span> /etc/php/7.4/fpm/pool.d/www.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保Nginx配置中使用相同路径</span></span><br><span class="line">fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="7-4-性能问题"><a href="#7-4-性能问题" class="headerlink" title="7.4 性能问题"></a>7.4 性能问题</h3><p>常见解决方案：</p>
<ol>
<li><p>启用慢日志分析</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; PHP慢日志</span></span><br><span class="line"><span class="attr">slowlog</span> = /var/log/php-fpm/slow.log</span><br><span class="line"><span class="attr">request_slowlog_timeout</span> = <span class="number">5</span>s</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用性能分析工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install php-xdebug  <span class="comment"># Ubuntu/Debian</span></span><br><span class="line">yum install php-pecl-xdebug  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>分析MySQL查询</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用慢查询日志</span></span><br><span class="line">slow_query_log = 1</span><br><span class="line">slow_query_log_file = /var/log/mysql/slow.log</span><br><span class="line">long_query_time = 1</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>配置高性能、安全的Web服务器需要综合考虑多方面因素，包括Web服务器本身的配置、PHP解释器的优化、SSL证书的设置、安全加固措施以及性能优化。</p>
<p>无论选择Nginx还是Apache，通过合理配置和优化，都可以构建出性能优异、安全可靠的网站服务器，为用户提供出色的访问体验。</p>
<p>定期的监控和维护也是确保服务器长期稳定运行的关键，建议制定完善的备份和监控策略。 </p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/AI%E7%94%9F%E6%88%90/" rel="tag"># AI生成</a>
              <a href="/tags/nginx/" rel="tag"># nginx</a>
              <a href="/tags/apache/" rel="tag"># apache</a>
              <a href="/tags/web/" rel="tag"># web</a>
              <a href="/tags/ssl/" rel="tag"># ssl</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/03/28/linux/SSH%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE/" rel="prev" title="SSH安全最佳实践">
                  <i class="fa fa-angle-left"></i> SSH安全最佳实践
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/03/29/vps/cloudflare%E9%85%8D%E7%BD%AE/" rel="next" title="cloudflare配置">
                  cloudflare配置 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">zfonlyone</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
